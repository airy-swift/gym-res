name: Trigger Job Via API

on:
  workflow_dispatch:
    inputs:
      jobId:
        description: 'Existing job ID to process'
        required: true

jobs:
  process-job:
    runs-on: ubuntu-latest
    env:
      API_BASE_URL: ${{ secrets.API_BASE_URL }}
      API_TOKEN: ${{ secrets.API_TOKEN }}
      JOB_ID: ${{ inputs.jobId }}
      JOB_BRANCH: ${{ inputs.jobId }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set timezone to JST
        run: |
          sudo timedatectl set-timezone Asia/Tokyo
          date

      - name: Prepare job branch
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git fetch origin
          git checkout -B "$JOB_BRANCH"

      - name: Validate configuration
        run: |
          test -n "$API_BASE_URL" || { echo 'API_BASE_URL secret is required'; exit 1; }
          test -n "$API_TOKEN" || { echo 'API_TOKEN secret is required'; exit 1; }
          test -n "$JOB_ID" || { echo 'workflow_dispatch input jobId is required'; exit 1; }

      - name: Fetch job data
        run: |
          set -euo pipefail
          JOB_JSON=$(curl -sSf -G "$API_BASE_URL/api/jobs" \
            -H "API_TOKEN: $API_TOKEN" \
            --data-urlencode "jobId=$JOB_ID" \
            -H 'Accept: application/json')

          SERVICE_USER=$(echo "$JOB_JSON" | jq -r '.userId')
          SERVICE_PASS=$(echo "$JOB_JSON" | jq -r '.password')
          ENTRY_COUNT=$(echo "$JOB_JSON" | jq -r '.entryCount')
          GROUP_ID=$(echo "$JOB_JSON" | jq -r '.groupId // empty')

          echo "::add-mask::$SERVICE_USER"
          echo "::add-mask::$SERVICE_PASS"

          if [ -z "$GROUP_ID" ]; then
            echo 'groupId is required in job data'
            exit 1
          fi

          echo "SERVICE_USER=$SERVICE_USER" >> "$GITHUB_ENV"
          echo "SERVICE_PASS=$SERVICE_PASS" >> "$GITHUB_ENV"
          echo "ENTRY_COUNT=$ENTRY_COUNT" >> "$GITHUB_ENV"
          echo "PLAYWRIGHT_GROUP_ID=$GROUP_ID" >> "$GITHUB_ENV"

      - name: Run reservation job
        id: run_reservation
        env:
          SERVICE_USER: ${{ env.SERVICE_USER }}
          SERVICE_PASS: ${{ env.SERVICE_PASS }}
          ENTRY_COUNT: ${{ env.ENTRY_COUNT }}
          PLAYWRIGHT_GROUP_ID: ${{ env.PLAYWRIGHT_GROUP_ID }}
        run: |
          set -euo pipefail
          SERVICE_USER="$SERVICE_USER" \
          SERVICE_PASS="$SERVICE_PASS" \
          ENTRY_COUNT="$ENTRY_COUNT" \
          npm install
          npx playwright install --with-deps
          xvfb-run -a npm run play 2>&1 | tee play.log
        working-directory: playwright
        continue-on-error: true

      - name: Build error summary
        if: always()
        run: |
          if [ -f playwright/play.log ]; then
            tail -n 20 playwright/play.log > job-error-summary.txt
          else
            echo 'No play.log captured' > job-error-summary.txt
          fi

          {
            echo "JOB_ERROR_SUMMARY<<'EOF'"
            cat job-error-summary.txt
            echo 'EOF'
          } >> "$GITHUB_ENV"

          if [ -f playwright/log.txt ]; then
            {
              echo "RESERVATION_LOG<<'EOF'"
              cat playwright/log.txt
              echo 'EOF'
            } >> "$GITHUB_ENV"
          else
            echo "RESERVATION_LOG=log.txt not found" >> "$GITHUB_ENV"
          fi

      - name: Commit debug screenshot
        if: always()
        run: |
          set -euo pipefail
          if [ -f playwright/debug.png ]; then
            git add playwright/debug.png
            if git diff --cached --quiet; then
              echo 'No screenshot changes to commit.'
              git reset HEAD --quiet
            else
              git commit -m "Add debug screenshot for job $JOB_ID (run $GITHUB_RUN_ID)"
              git push origin "$JOB_BRANCH"
            fi
          else
            echo 'No debug screenshot to commit.'
          fi

      - name: Update job status on failure
        if: failure()
        run: |
          SUMMARY_FILE="job-error-summary.txt"
          if [ ! -f "$SUMMARY_FILE" ]; then
            echo 'No summary available' > "$SUMMARY_FILE"
          fi

          PAYLOAD=$(jq -n \
            --arg jobId "$JOB_ID" \
            --arg status "failed" \
            --arg runId "$GITHUB_RUN_ID" \
            --arg reservationLog "${RESERVATION_LOG:-log.txt not found}" \
            --rawfile log "$SUMMARY_FILE" \
            '{jobId: $jobId, status: $status, message: ("GitHub Actions run " + $runId + " failed.\n\nLast log lines:\n" + $log + "\n\nReservation summary:\n" + $reservationLog)}')

          curl -sSf -X PATCH "$API_BASE_URL/api/jobs" \
            -H 'Content-Type: application/json' \
            -H "API_TOKEN: $API_TOKEN" \
            -d "$PAYLOAD"

      - name: Update job status on success
        if: success()
        run: |
          LOG_SUMMARY=${RESERVATION_LOG:-log.txt not found}
          MESSAGE=$(printf 'GitHub Actions run %s succeeded.\n\nReservation summary:\n%s' "$GITHUB_RUN_ID" "$LOG_SUMMARY")
          PAYLOAD=$(jq -n \
            --arg jobId "$JOB_ID" \
            --arg status "completed" \
            --arg message "$MESSAGE" \
            '{jobId: $jobId, status: $status, message: $message}')

          curl -sSf -X PATCH "$API_BASE_URL/api/jobs" \
            -H 'Content-Type: application/json' \
            -H "API_TOKEN: $API_TOKEN" \
            -d "$PAYLOAD"
